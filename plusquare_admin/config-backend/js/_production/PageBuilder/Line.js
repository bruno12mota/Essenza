define(["jquery","libraries/jquery.mobile.vmouse","ui/ui-elements","libraries/inheritance"],function(f){var l=function(a,c,d){this.id=c;this.modules=[];this.holder=f("<div class='line-holder'></div>").appendTo(a).hover(f.proxy(this.overThis,this));this.baseline=d.clone().appendTo(a)};l.prototype={overThis:function(){f(this).trigger("overThis",[this.id]);return!1},isEmpty:function(){return 0==this.modules.length},getOffsetY:function(){return this.holder.offset().top},hasOnly:function(a){return 1==
this.modules.length&&this.modules[0].number==a.number},occupyGrid:function(a,c,d,e){for(var b=a;b<a+c;b++)d[b]=e;return d},canFitIn:function(a,c,d){for(var e=c,b=a;b<a+c&&-1==d[b];b++)e--;return e},organize:function(){var a=this.getPriority(),c=[],d=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],e;for(e=0;e<a.length;e++){var b=this.modules[a[e]];12<b.column+b.size&&(b.column=12-b.size);var h=this.canFitIn(b.column,b.size,d);if(0==h)d=this.occupyGrid(b.column,b.size,d,a[e]);else{for(var k=b.column-1,g=0;0<=
k&&-1==d[k];)g++,k--;if(g>=h)b.column-=h;else{k=b.column+1;h=0;for(g=-1;12>k;){if(-1==d[k]){if(0==h&&(g=k),h++,h==b.size)break}else h=0,g=-1;k++}if(h==b.size)b.column=g;else break;d=this.occupyGrid(b.column,b.size,d,a[e])}}}for(g=h=k=0;12>g;g++)if(-1==d[g])h++;else{b=this.modules[d[g]];b.line!=this.id?this.appendModuleAt(b,k):b.positionInLine!=e&&(this.removeModuleFromHolder(b),this.appendModuleAt(b,k));0<h?b.changeOffset(h):b.changeOffset(0);h=0;k++;for(b=d[g];d[g]==b&&12>g;)g++;g--}if(e!=a.length){for(e;e<
a.length;e++)b=this.modules[a[e]],c.push(b);f.each(c,f.proxy(function(a,b){this.removeModule(b.number)},this))}return c},getPriority:function(){var a=[];f.each(this.modules,function(b,c){3!=c.priority&&2!=c.priority||a.push(b)});if(this.modules.length>a.length)for(var c=0;12>c;c++){var d=this.getModulesInColumn(c);if(1==d.length)addIfDoesnExist(d[0],a);else if(1<d.length)for(;0<d.length;){var e=this.getHighestPriorityModule(d);addIfDoesnExist(d[e],a);d=removePositionInArray(d,e)}}return a},getHighestPriorityModule:function(a){var c=
-1,d;f.each(a,f.proxy(function(a,b){this.modules[b].priority>c&&(c=this.modules[b].priority,d=a);1==this.modules[b].priority&&(this.modules[b].priority=0)},this));return d},getModulesInColumn:function(a){var c=[];f.each(this.modules,function(d,e){e.column==a&&c.push(d)});return c},popModules:function(){for(var a=this.modules;0<this.modules.length;)this.removeModule(this.modules[0].number);return a},pushModules:function(a,c){void 0==c&&(c=!0);a&&f.each(a,f.proxy(function(a,e){e.priority=1;c&&(e.column=
0);this.addModule(e)},this))},getModuleById:function(a){for(var c=0;c<this.modules.length;c++)if(this.modules[c].number==a)return c;return-1},appendModuleAt:function(a,c){0===c?this.holder.prepend(a.$obj):f(">div:nth-child("+c+")",this.holder).after(a.$obj);a.rebind();a.update(!1);var d=this.id;f.each(this.modules,function(a,b){b.line==d&&b.positionInLine>=c&&b.positionInLine++});a.line=this.id;a.positionInLine=c},removeModuleFromHolder:function(a){var c=a.positionInLine;a.$obj.remove();var d=this.id;
f.each(this.modules,function(a,b){b.line==d&&b.positionInLine>c&&b.positionInLine--})},getModuleInColumn:function(a){var c=null;f.each(this.modules,function(d,e){e.positionInLine==a&&(c=e)});return c},hasColumnInEnd:function(){var a=!1;f.each(this.modules,function(c,d){12<=d.column+d.size&&(a=!0)});return a},getOrderedModules:function(){for(var a=[],c=0;12>c;c++){var d=this.getModuleInColumn(c);null!=d&&addIfDoesnExist(d.number,a)}return a},addModule:function(a){this.modules.push(a)},removeModule:function(a){a=
this.getModuleById(a);-1!=a&&(this.modules[a].line==this.id&&this.removeModuleFromHolder(this.modules[a]),this.modules=removePositionInArray(this.modules,a))}};return{newLine:l}});
