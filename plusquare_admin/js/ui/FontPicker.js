define(["jquery","utils/utils"],function(b){var f,c,l,n=function(a,p){l=b("#"+a);this.$picker=b("#"+a+"_picker");f=this.$picker.find(".panel:first-child");c=this.$picker.find(".panel:last-child");f.find(".font").each(function(a,c){new m(b(c))});c.bind("change",b.proxy(this.changed,this));this.setValue(p)};n.prototype={setValue:function(a){b.each(a.items,function(a,e){var h=e.family,d=f.find(".font[rel="+h+"]");if(0==d.length)console.log("Error loading google font!");else{d=d.clone();c.find(".panel-inner").append(d);
var q=e.variants;d.find(".format").removeClass("selected");b.each(q,function(a,b){d.find(".format[rel="+b+"]").addClass("selected")});new k(d);f.find(".font[rel="+h+"]").css("display","none")}})},changed:function(){var a=[],f=[],e='{"items": [',h=0;c.find(".font").each(function(){var d=b(this),c=b(this).attr("rel"),g=[];0==d.find(".format").length?g.push(d.find(".font_formats").attr("rel")):(d=d.find(".format.selected"),0<d.length&&d.each(function(){g.push(b(this).attr("rel"))}));if(0<g.length){0!=
h&&(e+=",");e+='{ "family": "'+c+'","variants": [';for(d=0;d<g.length;d++)e+='"'+g[d]+'"',d!=g.length-1&&(e+=","),a.push(c+" ("+g[d]+")"),f.push(c+":"+g[d]);e+="]}";h++}});e+="]}";l.val(e);this.$picker.trigger("changeFonts",[a,f])}};var m=function(a){this.$font=a;this.$font.bind(mouseDownBind,b.proxy(this.startDrag,this))};m.prototype={updateDragPosition:function(){this.$dragObj.css({top:this.posTop+"px",left:this.posLeft+"px"})},startDrag:function(a){this.$dragObj=this.$font.clone().appendTo("body").css({position:"absolute",
width:this.$font.width()+"px"}).addClass("down");this.posLeft=this.$font.offset().left;this.posTop=this.$font.offset().top;this.currentLeft=a.pageX;this.currentTop=a.pageY;this.panelRangeMinLeft=c.offset().left;this.panelRangeMinTop=c.offset().top;this.panelRangeMaxLeft=this.panelRangeMinLeft+c.width();this.panelRangeMaxTop=this.panelRangeMinTop+c.height();this.updateDragPosition();b(document).bind(mouseMoveBind,b.proxy(this.drag,this));b(document).bind(mouseUpBind,b.proxy(this.stopDrag,this));return!1},
drag:function(a){this.posLeft+=a.pageX-this.currentLeft;this.posTop+=a.pageY-this.currentTop;this.currentLeft=a.pageX;this.currentTop=a.pageY;this.currentLeft>=this.panelRangeMinLeft&&this.currentLeft<=this.panelRangeMaxLeft&&this.currentTop>=this.panelRangeMinTop&&this.currentTop<=this.panelRangeMaxTop?c.addClass("active"):c.removeClass("active");this.updateDragPosition();return!1},stopDrag:function(a){unbindMoveAndUp();this.$dragObj.removeClass("down").stop().fadeTo(200,0,b.proxy(this.fate,this));
return!1},fate:function(){var a=this.$dragObj.attr("rel");this.$dragObj.remove();c.hasClass("active")&&0==c.find(".font[rel="+a+"]").length&&(f.find(".font[rel="+a+"]").slideUp(200),c.find(".panel-inner").append(this.$dragObj.css({position:"relative",width:"",top:"0",left:"0"}).fadeTo(200,1)),new k(this.$dragObj));c.removeClass("active")}};var k=function(a){this.$font=a.removeClass("grabhand").addClass("active");this.rel=a.attr("rel");this.$formatsHolder=this.$font.find(".formats_holder");this.num_formats=
this.$formatsHolder.find(".format").click(b.proxy(this.clicked,this)).length;this.font_formats=this.$font.find(".font_formats");this.$closeButton=this.$font.find(".font_title a").click(b.proxy(this.remove,this));this.$expandButton=this.$font.find(".expand").click(b.proxy(this.expand,this));this.changeFormatsText();c.trigger("change")};k.prototype={changeFormatsText:function(){if(1<this.num_formats){var a=this.$font.find(".formats_holder .format.selected").length;this.font_formats.text(a+"/"+this.num_formats+
" formats")}},expand:function(){var a=this.$expandButton;this.$formatsHolder.slideToggle(300,function(){b(this).is(":visible")?a.addClass("opened"):a.removeClass("opened")});return!1},clicked:function(a){a=b(a.target);a.hasClass("selected")?a.removeClass("selected"):a.addClass("selected");this.changeFormatsText();c.trigger("change");return!1},remove:function(){this.$font.slideUp(200,function(){b(this).remove();c.trigger("change")});f.find(".font[rel="+this.rel+"]").slideDown(200);return!1}};return n});
